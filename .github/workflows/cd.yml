name: CD - Deploy Cyber Mole

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Deploy para Heroku (Staging)
  deploy-staging:
    name: ğŸš€ Deploy Staging (Heroku)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: staging
      url: https://cyber-mole-staging.herokuapp.com
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Instalar Heroku CLI
      run: |
        curl https://cli-assets.heroku.com/install.sh | sh
    
    - name: ğŸ” Login Heroku
      env:
        HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      run: |
        echo "HEROKU_API_KEY=${HEROKU_API_KEY}" >> $GITHUB_ENV
    
    - name: ğŸš€ Deploy para Heroku
      run: |
        heroku git:remote -a cyber-mole-staging
        git push heroku main
    
    - name: ğŸƒ Executar migrations (se houver)
      run: |
        heroku run python -c "print('App deployed successfully!')" -a cyber-mole-staging
    
    - name: âœ… Verificar deploy
      run: |
        curl -f https://cyber-mole-staging.herokuapp.com || exit 1

  # Job 2: Deploy para Azure App Service (Production)
  deploy-production:
    name: ğŸŒŸ Deploy Production (Azure)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://cyber-mole.azurewebsites.net
    needs: []
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        pip install -r requirements.txt
    
    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ğŸš€ Deploy para Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'cyber-mole'
        package: .
    
    - name: âœ… Verificar deploy
      run: |
        sleep 10
        curl -f https://cyber-mole.azurewebsites.net || exit 1

  # Job 3: Deploy para GitHub Pages (Static)
  deploy-pages:
    name: ğŸ“„ Deploy GitHub Pages
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Criar documentaÃ§Ã£o estÃ¡tica
      run: |
        mkdir -p public
        cp README.md public/
        cp -r docs/* public/ 2>/dev/null || true
        
        # Criar index.html redirecionando para app
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Cyber Mole - Redirecting...</title>
          <meta http-equiv="refresh" content="0; url=https://cyber-mole.azurewebsites.net">
        </head>
        <body>
          <h1>ğŸ¤– CYBER MOLE</h1>
          <p>Redirecionando para o jogo...</p>
          <a href="https://cyber-mole.azurewebsites.net">Clique aqui se nÃ£o for redirecionado</a>
        </body>
        </html>
        EOF
    
    - name: ğŸ“¤ Upload para Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: public
    
    - name: ğŸš€ Deploy para Pages
      uses: actions/deploy-pages@v4

  # Job 4: Docker Build e Push
  docker:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ” Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ğŸ“¦ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/cyber-mole
        tags: |
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
    
    - name: ğŸ—ï¸ Build e Push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

  # Job 5: Criar Release
  release:
    name: ğŸ“¦ Criar GitHub Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [deploy-production, deploy-pages, docker]
    permissions:
      contents: write
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ“ Gerar Changelog
      id: changelog
      run: |
        # Gera changelog automÃ¡tico
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s (%h)" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: ğŸ“¦ Criar arquivos de release
      run: |
        mkdir -p release
        cp app.py requirements.txt README.md release/
        tar -czf cyber-mole-${{ github.ref_name }}.tar.gz release/
        zip -r cyber-mole-${{ github.ref_name }}.zip release/
    
    - name: ğŸ‰ Criar Release
      uses: softprops/action-gh-release@v1
      with:
        name: Cyber Mole ${{ github.ref_name }}
        body: |
          ## ğŸ¤– Cyber Mole ${{ github.ref_name }}
          
          ### ğŸ® O que hÃ¡ de novo:
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ### ğŸ“¥ Downloads:
          - **CÃ³digo Fonte**: [tar.gz](https://github.com/${{ github.repository }}/archive/${{ github.ref_name }}.tar.gz) | [zip](https://github.com/${{ github.repository }}/archive/${{ github.ref_name }}.zip)
          - **Docker**: `docker pull ${{ secrets.DOCKER_USERNAME }}/cyber-mole:${{ github.ref_name }}`
          
          ### ğŸš€ Deploy:
          - **Production**: https://cyber-mole.azurewebsites.net
          - **Docs**: https://${{ github.repository_owner }}.github.io/cyber-mole
          
          ---
          **InstalaÃ§Ã£o RÃ¡pida:**
          ```bash
          pip install -r requirements.txt
          python app.py
          ```
        files: |
          cyber-mole-${{ github.ref_name }}.tar.gz
          cyber-mole-${{ github.ref_name }}.zip
        draft: false
        prerelease: false

  # Job 6: NotificaÃ§Ã£o de Deploy
  notify-deploy:
    name: ğŸ“¢ Notificar Deploy
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production, release]
    if: always()
    
    steps:
    - name: ğŸ“Š Status do Deploy
      run: |
        echo "ğŸš€ Deploy finalizado!"
        echo "Staging: ${{ needs.deploy-staging.result }}"
        echo "Production: ${{ needs.deploy-production.result }}"
        echo "Release: ${{ needs.release.result }}"
