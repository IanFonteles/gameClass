name: CI - Cyber Mole

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Lint e validaÃ§Ã£o de cÃ³digo
  lint:
    name: ğŸ” Lint e Qualidade
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pylint flake8 black
    
    - name: ğŸ¨ Verificar formataÃ§Ã£o (Black)
      run: black --check app.py
    
    - name: ğŸ” AnÃ¡lise estÃ¡tica (Pylint)
      run: pylint app.py --disable=C0111,R0903
      continue-on-error: true
    
    - name: âœ… Verificar PEP8 (Flake8)
      run: flake8 app.py --max-line-length=120 --ignore=E501,W503
      continue-on-error: true

  # Job 2: Testes automatizados
  test:
    name: ğŸ§ª Testes
    runs-on: ubuntu-latest
    needs: lint
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-flask
    
    - name: ğŸ§ª Executar testes
      run: |
        # Criar testes bÃ¡sicos se nÃ£o existirem
        mkdir -p tests
        echo "import pytest
        from app import app

        @pytest.fixture
        def client():
            app.config['TESTING'] = True
            with app.test_client() as client:
                yield client

        def test_home_page(client):
            '''Testa se pÃ¡gina principal carrega'''
            rv = client.get('/')
            assert rv.status_code == 200
            assert b'CYBER MOLE' in rv.data

        def test_api_score(client):
            '''Testa endpoint de score'''
            rv = client.get('/api/score/test-session')
            assert rv.status_code == 200
            json_data = rv.get_json()
            assert 'score' in json_data
        " > tests/test_app.py
        
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=term
    
    - name: ğŸ“Š Upload coverage para Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-${{ matrix.python-version }}
      continue-on-error: true

  # Job 3: Security scan
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        pip install safety bandit
    
    - name: ğŸ” Verificar vulnerabilidades (Safety)
      run: safety check --json
      continue-on-error: true
    
    - name: ğŸ”’ AnÃ¡lise de seguranÃ§a (Bandit)
      run: bandit -r app.py -f json
      continue-on-error: true

  # Job 4: Build e validaÃ§Ã£o
  build:
    name: ğŸ—ï¸ Build e ValidaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        pip install -r requirements.txt
    
    - name: ğŸš€ Testar inicializaÃ§Ã£o do servidor
      run: |
        timeout 10s python app.py || code=$?
        if [ $code -eq 124 ]; then
          echo "âœ… Servidor iniciou com sucesso (timeout esperado)"
          exit 0
        else
          echo "âŒ Erro ao iniciar servidor"
          exit 1
        fi
    
    - name: ğŸ“¦ Criar artefato de build
      run: |
        mkdir -p dist
        cp app.py requirements.txt README.md dist/
        tar -czf cyber-mole-${{ github.sha }}.tar.gz dist/
    
    - name: ğŸ“¤ Upload artefato
      uses: actions/upload-artifact@v4
      with:
        name: cyber-mole-build
        path: cyber-mole-*.tar.gz
        retention-days: 30

  # Job 5: Lighthouse CI (Performance)
  lighthouse:
    name: ğŸš¦ Lighthouse Performance
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: pip install -r requirements.txt
    
    - name: ğŸš€ Iniciar servidor
      run: python app.py &
      
    - name: â³ Aguardar servidor
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:5000; do sleep 1; done'
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ğŸš¦ Executar Lighthouse CI
      run: |
        npm install -g @lhci/cli
        lhci autorun --config=.lighthouserc.json || echo "Lighthouse config nÃ£o encontrado"
      continue-on-error: true

  # Job 6: Notification
  notify:
    name: ğŸ“¢ NotificaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [lint, test, security, build]
    if: always()
    
    steps:
    - name: ğŸ“Š Status do Pipeline
      run: |
        echo "Pipeline finalizado!"
        echo "Lint: ${{ needs.lint.result }}"
        echo "Tests: ${{ needs.test.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo "Build: ${{ needs.build.result }}"
